@{
    ViewData["Title"] = "User Dashboard - PolicyPro360";
    Layout = "_UserDashboardLayout";
}
@model PolicyPro360.ViewModels.DashboardViewModel

@{
    var typeCounts = Model.Policies
        .GroupBy(p => p.Policy.Category?.Name ?? "Other")
        .Select(g => new { Type = g.Key, Count = g.Count() })
        .OrderByDescending(g => g.Count)
        .ToList();
    var total = typeCounts.Sum(x => x.Count);
}


<style>
    .bg-orange-subtle {
        background-color: rgba(255, 165, 0, 0.32) !important;
    }
 
    .gradient-card {
        border-radius: 12px;
        border: none;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

        .gradient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .gradient-card .card-title {
            color: white;
            opacity: 0.9;
        }

 
    .card-gradient-purple {
        background-image: linear-gradient(45deg, #aa4b6b, #6b6b83 ,#3b8d99);
    }


    .card-gradient-teal {
        background-image: linear-gradient(45deg, #f5a526, #f5a526 );
    }


    .timeline-list-light {
        list-style: none;
        padding-left: 0;
    }

    .timeline-list-item-light {
        position: relative;
        padding-left: 25px;
        padding-bottom: 15px;
        border-left: 2px solid rgba(255, 255, 255, 0.3);
    }

        .timeline-list-item-light:last-child {
            border-left: 2px solid transparent;
            padding-bottom: 0;
        }

        .timeline-list-item-light::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ffffff;
        }

        .timeline-list-item-light h6 {
            color: white;
        }

        .timeline-list-item-light small {
            color: white;
            opacity: 0.7;
        }


    .summary-item-light {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 8px;
    }

    .summary-icon-light {
        font-size: 1.2rem;
        color: white;
    }

    .summary-item-light .fw-semibold {
        color: white;
    }

    .summary-item-light .fw-bolder {
        color: white;
    }
</style>
<div class="body-wrapper-inner">
    <div class="container-fluid">
        <!--  Row 1: Welcome Message and Quick Actions -->
        <div class="row">
            <!-- Welcome Message -->
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <h4 class="fw-semibold mb-0">Hello, @ViewBag.name</h4>
                        <p class="mb-0 text-muted">Detailed View of Your Insurance Coverage</p>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <!-- Quick Action Cards -->

            <div class="col-lg-8 d-flex align-items-stretch">
                <div class="card w-100">
                    <div class="card-body">
                        <h5 class="card-title fw-semibold mb-4">Quick Actions</h5>
                        <div class="row">

                            <!-- Pay Premium Card -->
                            <div class="col-md-6 mb-4">
                                <a href="@Url.Action("makepayment", "UserHome")" class="text-decoration-none">
                                    <div class="card card-hover bg-primary-subtle shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <span class="btn btn-primary rounded-circle round-48 hstack justify-content-center">
                                                    <i class="ti ti-wallet text-white fs-6"></i>
                                                </span>
                                                <div class="ms-3">
                                                    <h6 class="mb-0 fw-semibold">Pay Premium</h6>
                                                    <span class="fs-2 text-muted">Settle your dues on time</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>

                            <!-- File a Claim Card -->
                            <div class="col-md-6 mb-4">
                                <a href="@Url.Action("fileclaim", "UserHome")" class="text-decoration-none">
                                    <div class="card card-hover bg-success-subtle shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <span class="btn btn-success rounded-circle round-48 hstack justify-content-center">
                                                    <i class="ti ti-clipboard-plus text-white fs-6"></i>
                                                </span>
                                                <div class="ms-3">
                                                    <h6 class="mb-0 fw-semibold">File a Claim</h6>
                                                    <span class="fs-2 text-muted">Start your claim process</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <!-- View Policies Card -->
                            <div class="col-md-6 mb-md-0 mb-4">
                                <a href="@Url.Action("MyPolicies", "UserHome")" class="text-decoration-none">
                                    <div class="card card-hover bg-orange-subtle shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <span class="btn btn-warning rounded-circle round-48 hstack justify-content-center">
                                                    <i class="ti ti-shield text-white fs-6"></i>
                                                </span>
                                                <div class="ms-3">
                                                    <h6 class="mb-0 fw-semibold">View My Policies</h6>
                                                    <span class="fs-2 text-muted">Check your coverage details</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <!-- Track Your Claim Card -->
                            <div class="col-md-6 mb-4">
                                <a href="@Url.Action("TrackClaim", "UserHome")" class="text-decoration-none">
                                    <div class="card card-hover bg-primary-subtle shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <span class="btn btn-primary rounded-circle round-48 hstack justify-content-center">
                                                    <i class="ti ti-search text-white fs-6"></i>
                                                </span>
                                                <div class="ms-3">
                                                    <h6 class="mb-0 fw-semibold">Track Your Claim</h6>
                                                    <span class="fs-2 text-muted">Monitor claim status</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>

                         

                            <!-- Apply for Loan Card -->
                            <div class="col-md-6 mb-md-0 mb-4">
                                <a href="@Url.Action("applyloan", "UserHome")" class="text-decoration-none">
                                    <div class="card card-hover bg-info-subtle shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <span class="btn btn-info rounded-circle round-48 hstack justify-content-center">
                                                    <i class="ti ti-cash text-white fs-6"></i>
                                                </span>
                                                <div class="ms-3">
                                                    <h6 class="mb-0 fw-semibold">Apply for Loan</h6>
                                                    <span class="fs-2 text-muted">Get funds against your policy</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <!-- app Card -->
                            <div class="col-md-6 mb-4">
                                <a href="@Url.Action("myapplication", "UserHome")" class="text-decoration-none">
                                    <div class="card card-hover bg-orange-subtle shadow-none">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <span class="btn btn-primary rounded-circle round-48 hstack justify-content-center">
                                                    <i class="ti ti-search text-white fs-6"></i>
                                                </span>
                                                <div class="ms-3">
                                                    <h6 class="mb-0 fw-semibold">Your Applications</h6>
                                                    <span class="fs-2 text-muted">Manage your submitted claim and loans</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Policy Summary Card -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="card overflow-hidden w-100">
                    <div class="card-body">
                        <h5 class="card-title fw-semibold mb-4">Policy Summary</h5>
                        <div class="py-3 d-flex align-items-center border-bottom">
                            <span class="btn btn-primary rounded-circle round-48 hstack justify-content-center">
                                <i class="ti ti-shield-check fs-6"></i>
                            </span>
                            <div class="ms-3">
                                <h5 class="mb-0 fw-bolder fs-4">@Model.ActivePolicies</h5>
                                <span class="text-muted fs-3">Active Policies</span>
                            </div>
                        </div>
                        <div class="py-3 d-flex align-items-center border-bottom">
                            <span class="btn btn-warning rounded-circle round-48 hstack justify-content-center">
                                <i class="ti ti-report-money fs-6"></i>
                            </span>
                            <div class="ms-3">
                                <h5 class="mb-0 fw-bolder fs-4">PKR @Model.TotalPremium</h5>
                                <span class="text-muted fs-3">Total Annual Premium</span>
                            </div>
                        </div>
                        <div class="pt-3 d-flex align-items-center">
                            <span class="btn btn-danger rounded-circle round-48 hstack justify-content-center">
                                <i class="ti ti-alert-circle fs-6"></i>
                            </span>
                            <div class="ms-3">
                                <h5 class="mb-0 fw-bolder fs-4">
                                    @(
                                           Model.NextPaymentDue.HasValue && Model.NextPaymentDue.Value != DateTime.MinValue
                                            ? Model.NextPaymentDue.Value.ToString("MMMM dd, yyyy")
                                            : "N/A"
                                             )
                                </h5>

                                <span class="text-muted fs-3">Payment Due Soon</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Policy Coverage Chart -->
            <div class="col-lg-5 d-flex align-items-stretch">
                <div class="card w-100">
                    <div class="card-body">
                        <h5 class="card-title fw-semibold">My Policy Types</h5>
                        <div class="d-flex flex-column gap-3 mt-4">
                            @foreach (var t in typeCounts)
                            {
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="round-8 bg-primary rounded-circle"></span>
                                        <p class="mb-0">@t.Type</p>
                                    </div>
                                    <p class="mb-0 fw-bolder">
                                        @t.Count (@(total > 0 ? ((t.Count * 100) / total) : 0)%)
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <!-- Recent Applications Status -->
            <div class="col-lg-7 d-flex align-items-stretch">
                <div class="card w-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title fw-semibold mb-0">Recent Applications Status</h5>
                            <a href="@Url.Action("myapplication", "UserHome")" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table text-nowrap mb-0 align-middle">
                                <tbody>
                                    @foreach (var app in Model.RecentApplications)
                                    {
                                        <tr>
                                            <td>
                                                <h6 class="fw-semibold mb-1">@app.ApplicationId</h6>
                                                <span class="fw-normal">For @app.PolicyName</span>
                                            </td>
                                            <td><span class="badge @(app.Status == "Approved" ? "bg-success-subtle text-success" : app.Status == "Pending" ? "bg-warning-subtle text-warning" : "bg-danger-subtle text-danger")">@app.Status</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Row 2: Upcoming Payments & Applications Summary -->
        <div class="row">

            <!-- Left Column: Upcoming Premium Payments -->
            <div class="col-lg-8 d-flex align-items-stretch">
                <div class="card w-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title fw-semibold mb-0">Upcoming Premium Payments</h5>
                            <a href="@Url.Action("MyPolicies", "UserHome")" class="btn btn-sm btn-light">View All</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table payments-table align-middle">
                                <thead>
                                    <tr>
                                        <th>Policy Details</th>
                                        <th>Amount</th>
                                        <th>Due In</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.UpcomingPremiums != null && Model.UpcomingPremiums.Any())
                                    {
                                        @foreach (var pol in Model.UpcomingPremiums)
                                        {
                                            var daysRemaining = (pol.ExpiryDate - DateTime.Now).Days;
                                            var badgeColor = daysRemaining <= 7 ? "danger" : (daysRemaining <= 15 ? "warning" : "primary");
                                            var badgeText = daysRemaining <= 0 ? "Overdue" : $"{daysRemaining} days";

                                            <tr>
                                                <td>
                                                    <h6 class="fw-semibold mb-1">@pol.Policy.Name</h6>
                                                    <span class="fw-normal text-muted fs-3">@pol.Policy.Category.Name</span>
                                                </td>
                                                <td>
                                                    <p class="mb-0 fw-semibold">PKR @pol.CalculatedPremium.ToString("N0")</p>
                                                </td>
                                                <td>
                                                    <span class="badge rounded-pill bg-@(badgeColor)-subtle text-@(badgeColor)">
                                                        @badgeText
                                                    </span>
                                                </td>
                                                <td class="text-end">
                                                    <a href="@Url.Action("MakePayment", "UserHome", new { policyId = pol.Id })" class="btn btn-primary btn-sm rounded-pill">Pay Now</a>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="4" class="text-center py-5">
                                                <i class="ti ti-circle-check fs-6 text-success"></i>
                                                <p class="text-muted mt-2 mb-0">No upcoming payments. You're all set!</p>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Recent Purchases & Applications Summary -->
            <div class="col-lg-4">
                <div class="d-flex flex-column gap-4">

                    <!-- Colorful Card 1: Recent Policy Purchases -->
                    <div class="card gradient-card card-gradient-purple">
                        <div class="card-body">
                            <h5 class="card-title fw-semibold mb-4">Recent Policy Purchases</h5>
                            <ul class="timeline-list-light">
                                @if (Model.Policies != null && Model.Policies.Any())
                                {
                                    @foreach (var p in Model.Policies.OrderByDescending(x => x.PurchaseDate).Take(3))
                                    {
                                        <li class="timeline-list-item-light">
                                            <h6 class="fw-semibold mb-1">@p.Policy.Name</h6>
                                            <small>Purchased On: @p.PurchaseDate.ToString("MMM dd, yyyy")</small>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <li class="timeline-list-item-light border-0">
                                        <p class="mb-0" style="opacity: 0.7;">No recent purchases found.</p>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>

                    <!-- Colorful Card 2: Applications Summary -->
                    <div class="card gradient-card card-gradient-teal">
                        <div class="card-body">
                            <h5 class="card-title fw-semibold mb-4">My Applications Summary</h5>
                            <div class="d-flex flex-column gap-3">
                                <div class="summary-item-light d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-3">
                                        <i class="ti ti-clipboard-text summary-icon-light"></i>
                                        <span class="fw-semibold">Total Claims Filed</span>
                                    </div>
                                    <span class="fw-bolder fs-5">@Model.RecentApplications.Count(x => x.ApplicationType == "Claim")</span>
                                </div>
                                <div class="summary-item-light d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-3">
                                        <i class="ti ti-cash summary-icon-light"></i>
                                        <span class="fw-semibold">Total Loans Taken</span>
                                    </div>
                                    <span class="fw-bolder fs-5">@Model.RecentApplications.Count(x => x.ApplicationType == "Loan")</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
     
    </div>
</div>
<script src="~/admin/assets/js/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    var successMessage = "@TempData["success"]";

    if (successMessage === "Login successful!") {
        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });

        Toast.fire({
            icon: "success",
            title: successMessage
        });
    }
</script>
<!--end main wrapper-->